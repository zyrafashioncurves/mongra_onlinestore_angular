<p-fluid class="flex flex-wrap items-center justify-between gap-4">
  <div class="card flex flex-wrap items-center justify-between w-full">

    <!-- Title Section -->
    <div class="flex-1 min-w-[150px]">
      <h4 class="font-bold">Update variant</h4>
    </div>

    <!-- Button Section -->
    <div class="flex justify-end">
      <p-button pTooltip="save" tooltipPosition="left" label="Save Changes" icon="pi pi-save" raised severity="warn"
        size="large" (click)="openConfirmation()">
      </p-button>

      <p-dialog header="Confirmation" [(visible)]="displayConfirmation" [style]="{ width: '350px' }" [modal]="true">
        <div class="flex items-center justify-center">
          <i class="pi pi-info-circle mr-4" style="font-size: 3rem"> </i>
          <span>Are you sure you want to proceed?</span>
        </div>
        <ng-template #footer>
          <p-button label="No" icon="pi pi-times" (click)="closeConfirmation()" text severity="secondary" raised />
          <p-button label="Yes" icon="pi pi-check" (click)="updateVariant()" severity="warn" raised autofocus />
        </ng-template>
      </p-dialog>
    </div>

  </div>
</p-fluid>

<p-fluid class="flex mt-5">
  <div class="card flex flex-col gap-6 w-full ">
    <div class="font-semibold text-xl">Product Level Details</div>

    <div class="flex flex-wrap w-full">

      <!-- Name (null-safe display) -->
      <div class="w-full sm:w-1/2 lg:w-1/4  px-2 mb-4">
        <p-floatlabel variant="on">
          <input pInputText id="name" type="text" [ngModel]="product.name || '—'" [disabled]="true" class="w-full" />
          <label for="name">Name</label>
        </p-floatlabel>
      </div>
     

      <!-- Category -->
      <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
        <p-floatlabel variant="on">
          <input pInputText id="category" type="text" [(ngModel)]="product.category" [disabled]="true" class="w-full" />
          <label for="category">Category</label>
        </p-floatlabel>
      </div>
     

      <!-- Uploaded At -->
      <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
        <p-floatlabel variant="on">
          <input pInputText id="uploadedAt" type="text" [ngModel]="product.uploadedAt || '—'" [disabled]="true"
            class="w-full" />
          <label for="uploadedAt">Uploaded At</label>
        </p-floatlabel>
      </div>

    </div>
    <div class="flex w-full">
      <div class="basis-4/4 px-2 ">
        <p-floatlabel variant="on">
          <textarea pTextarea placeholder="product description" [(ngModel)]="product.description" [autoResize]="true"
            rows="3" cols="100" [disabled]="true"></textarea>
          <label for="description">Variant description</label>
        </p-floatlabel>
      </div>
    </div>
  </div>
</p-fluid>
<p-fluid class="flex flex-col md:flex-row gap-8 mt-5">
  <div class="md:w-4/4">
    <div class="card flex flex-col gap-4">
      <div class="font-semibold text-xl">Variant Details</div>
      <div class="flex flex-wrap w-full">

        <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4 px-2 ">
          <p-floatlabel variant="on">
            <input pInputText id="id" type="text" [ngModel]="product?.variant.id || '—'" [disabled]="true"
              class="w-full" />
            <label for="id">Variant Id</label>
          </p-floatlabel>
        </div>
        <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4 px-2 ">
          <p-floatlabel variant="on">
            <p-autocomplete [(ngModel)]="product.variant.color" [suggestions]="autoFilteredValue" optionLabel="name"
              [disabled]="true" field="name" dropdown (completeMethod)="filterCountry($event)" inputId="variantColor"
              class="w-full">
            </p-autocomplete>
            <label for="variantColor">Variant Color</label>
          </p-floatlabel>
        </div>
        <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4 px-2 ">
          <p-floatlabel variant="on">
            <input pInputText id="variantName" type="text" [(ngModel)]="product.variant.variantName" name="variantName"
              class="w-full" />
            <label for="variantName">Variant Name</label>
          </p-floatlabel>
        </div>

       

        <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
          <label for="rating" class="block mb-1 font-medium text-gray-700">Rating</label>
          <p-rating [(ngModel)]="product.variant.rating" name="rating" [stars]="5" inputId="rating"></p-rating>
          @if(!product.variant.rating){
          <small class="p-error text-red-800">Rating is required</small>
          }
        </div>

        <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4 flex items-center gap-4">
          <!-- Label with Info Icon -->
          <div class="flex items-center gap-1">
            <label for="isFeatured" class="font-medium">Featured?</label>

            <!-- Info Icon with Tooltip -->
            <i class="pi pi-info-circle text-blue-500 cursor-pointer"
              pTooltip="Featured items are highlighted on the main product page for better visibility."
              tooltipPosition="top">
            </i>
          </div>

          <!-- Toggle & Text Column -->
          <div class="flex flex-col items-center gap-1">
            <p-toggleswitch [(ngModel)]="product.variant.isFeatured" severity="success"
              class="scale-125 shadow-md rounded-lg">
              <ng-template #handle let-checked="checked">
                <i [ngClass]="['!text-xs', 'pi', checked ? 'pi-check' : 'pi-times']"></i>
              </ng-template>
            </p-toggleswitch>
          </div>
        </div>

        <!-- ============ FABRIC & PRODUCT DETAILS SECTION ============ -->



<!-- Made By -->
<div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
  <p-floatlabel variant="on">
    <input pInputText [(ngModel)]="product.variant.madeBy" name="madeBy" id="madeBy"
      placeholder="e.g. ZFC Studio / Local Artisans" class="w-full" />
    <label for="madeBy">Made By</label>
  </p-floatlabel>
</div>
        <div class="flex w-full mt-4">
          <div class="basis-4/4 px-2 ">
            <p-floatlabel variant="on">
              <textarea pTextarea placeholder="product description" [(ngModel)]="product.variant.variantDescription"
                [autoResize]="true" rows="3" cols="100"></textarea>
              <label for="description">Variant description</label>
            </p-floatlabel>
          </div>
        </div>



      </div>

      <div class="card flex flex-col gap-4 mt-6">
        <div class="flex justify-between items-center">
          <div class="font-semibold text-xl">Variant Sizes</div>
          <!-- Add New Size Button -->
          <div><p-button raised label="Add Size" pTooltip="Add new size" tooltipPosition="left" icon="pi pi-plus"
              severity="warn" (click)="addSize()">
            </p-button></div>
        </div>

        <p-table [value]="product?.variant?.sizes" dataKey="id" editMode="row" [responsiveLayout]="'scroll'"
          class="w-full">

          <!-- Table Headers -->
          <ng-template pTemplate="header">
            <tr>
              <th>Size</th>
              <th>Price</th>
              <th>Discount %</th>
              <th>SKU</th>
              <th>HSN</th>
              <th>Available Qty</th>
              <th>Threshold to notify</th>
              <th>Adjustment</th>
              <th>Availability</th>
              <th>Actions</th>
            </tr>
          </ng-template>

          <!-- Table Body -->
          <ng-template pTemplate="body" let-size let-editing="editing">
            <tr [pEditableRow]="size">

              <!-- Size -->
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <input pInputText [(ngModel)]="size.size" class="w-full" />
                  </ng-template>
                  <ng-template pTemplate="output">{{ size.size }}</ng-template>
                </p-cellEditor>
              </td>

              <!-- Price -->
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <p-inputnumber [(ngModel)]="size.price" mode="decimal" class="w-full" />
                  </ng-template>
                  <ng-template pTemplate="output">{{ size.price || '—' }}</ng-template>
                </p-cellEditor>
              </td>

              <!-- Discount -->
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <p-inputnumber [(ngModel)]="size.discountPercentage" mode="decimal" suffix="%" />
                  </ng-template>
                  <ng-template pTemplate="output">{{ size.discountPercentage }}%</ng-template>
                </p-cellEditor>
              </td>

              <!-- SKU -->
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <input pInputText [(ngModel)]="size.sku" />
                  </ng-template>
                  <ng-template pTemplate="output">{{ size.sku }}</ng-template>
                </p-cellEditor>
              </td>

              <!-- HSN -->
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <input pInputText [(ngModel)]="size.hsnCode" />
                  </ng-template>
                  <ng-template pTemplate="output">{{ size.hsnCode }}</ng-template>
                </p-cellEditor>
              </td>

              <!-- Available Qty -->
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <p-inputnumber [(ngModel)]="size.availableQuantity" mode="decimal" />
                  </ng-template>
                  <ng-template pTemplate="output">{{ size.availableQuantity }}</ng-template>
                </p-cellEditor>
              </td>

              <!-- Low Stock -->
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <p-inputnumber [(ngModel)]="size.lowStockThreshold" mode="decimal" />
                  </ng-template>
                  <ng-template pTemplate="output">{{ size.lowStockThreshold }}</ng-template>
                </p-cellEditor>
              </td>

              <td pEditableColumn>
                <p-cellEditor>
                  <!-- Input template -->
                  <ng-template pTemplate="input">
                    <p-inputNumber [(ngModel)]="size.stockAdjustment" inputId="stockAdjustment" mode="decimal"
                      [showButtons]="true" [min]="-size.availableQuantity" [step]="1" [placeholder]="'Adjust Stock'"
                      class="w-full">
                    </p-inputNumber>
                  </ng-template>

                  <!-- Output template -->
                  <ng-template pTemplate="output">
                    <span [ngClass]="{
        'text-green-700': size.stockAdjustment > 0,
        'text-red-700': size.stockAdjustment < 0,
        'text-gray-500': size.stockAdjustment === 0
      }">
                      {{ size.stockAdjustment || 0 }}
                    </span>
                  </ng-template>
                </p-cellEditor>
              </td>
              <td>
  <p-cellEditor>
    <ng-template pTemplate="input">
      <p-inputNumber [(ngModel)]="size.inventoryStatus" mode="decimal"></p-inputNumber>
    </ng-template>

    <ng-template pTemplate="output">
      <p-tag 
        [value]="getStatusLabel(size)"
        [severity]="getSeverity(size.availableQuantity)">
      </p-tag>
    </ng-template>
  </p-cellEditor>
</td>


              <!-- Row Actions -->
              <td>
                <div class="flex gap-2">
                  @if (!editing) {
                  <p-button rounded raised severity="info" outlined pTooltip="Edit" pButton icon="pi pi-pencil"
                    pInitEditableRow>
                  </p-button>
                  }
                  @if (editing) {
                  <p-button rounded raised severity="success" outlined pTooltip="Done" pButton icon="pi pi-check"
                    pSaveEditableRow>
                  </p-button>
                  }
                  @if (editing) {
                  <p-button rounded raised severity="secondary" outlined pTooltip="Cancel" pButton icon="pi pi-times"
                    pCancelEditableRow>
                  </p-button>
                  }
                  <p-button rounded raised severity="danger" outlined pTooltip="delete" pButton icon="pi pi-trash"
                    (click)="removeSize(size.id)">
                  </p-button>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>

</p-fluid>
<p-fluid class="flex flex-col md:flex-row gap-8 mt-5">
  <div class="md:w-1/2">
    <div class="card flex flex-col gap-4">

      <h5>Add more images of this variant</h5>
      <p-fileupload name="files[]" (onUpload)="onUpload($event)" [multiple]="true" accept="image/*"
        (onSelect)="onFileSelect($event)" maxFileSize="1000000" mode="advanced">
        <ng-template #empty>
          <div>Drag and drop files to here to upload.</div>
        </ng-template>
      </p-fileupload>
    </div>
  </div>
  <div class="md:w-1/2">
    <div class="card flex flex-col gap-4">
      <div class="font-semibold text-xl mb-2">Existing images of the variant</div>
      <p-galleria [thumbnailsPosition]="'top'" [responsiveOptions]="responsiveOptions" [value]="images"
        [showItemNavigators]="true" [circular]="true" [numVisible]="3" class="w-full lg:w-2/2">

        <!-- Full Image View -->
        <ng-template pTemplate="item" let-item>
          <div class="aspect-w-4 aspect-h-3 relative">
            <img [src]="item.itemImageSrc" [alt]="item.alt" class="object-contain w-full h-full rounded-lg shadow" />
          </div>
        </ng-template>

        <!-- Thumbnail with Delete Button -->
        <ng-template pTemplate="thumbnail" let-item>
          <div class="relative inline-block">
            <img [src]="item.thumbnailImageSrc" class="h-16 w-16 object-cover rounded" />

            <!-- Delete Button -->
            <p-button [rounded]="true" severity="danger" [text]="true" pRipple icon="pi pi-trash"
              (click)="deleteImage(item)">
            </p-button>
          </div>
        </ng-template>
      </p-galleria>
    </div>
  </div>
</p-fluid>
<div class="flex justify-end mt-5">
  <p-button pTooltip="save" tooltipPosition="left" label="Save Changes" icon="pi pi-save" raised severity="warn"
    size="large" (click)="openConfirmation()">
  </p-button>