<div class="mt-5">
    <h2 class=" card text-2xl font-bold mb-6 text-orange-500 flex items-center gap-2 mt-2">
        <i class="pi pi-history"></i>
        Your Order History
    </h2>

    <!-- Loading Spinner -->
    @if(loading){<p-progressSpinner strokeWidth="4"></p-progressSpinner>}

    <!-- Orders Exist -->
    @if(!loading && orders.length > 0){<ng-container>

        <!--  Desktop Table View -->
        <p-table [value]="orders" class="hidden lg:block" [scrollable]="true" scrollHeight="500px"
            [style]="{ 'min-width': '60rem' }">
            <ng-template pTemplate="header">
                <tr>
                    <th>Order #</th>
                    <th>Date</th>
                    <th>Total</th>
                    <th>Payment</th>
                    <th>Status</th>
                    <th>Items</th>
                    <th>Image</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-order>
                <tr (click)="openTrackingModal(order)" style="cursor: pointer;">
                    <td><p-tag severity="contrast" >
  {{ order.orderNumber }}
</p-tag></td>
                    <td>{{ order.orderDate | date: 'medium' }}</td>
                    <td>₹{{ order.totalAmount.toFixed(2) }}</td>
                    <td>{{ order.paymentMode || 'N/A' }}</td>
                    <td>{{ order.status }}</td>
                    <td>
                        <ul class="list-disc pl-4 text-sm">
                            @for (item of order.items; track item.variantId) {
                            <li>{{ item.productName }} ({{ item.quantity }}) - {{ item.size }}</li>
                            }

                        </ul>
                    </td>
                    <td>
                        <p-avatarGroup>
                            @for (item of order.items; track item.variantId) {
                            <p-overlay-badge [value]=item.quantity severity="contrast" class="flex">
                                <p-avatar [image]="item.imageUrl" shape="square" size="xlarge"></p-avatar>
                            </p-overlay-badge>
                            }

                        </p-avatarGroup>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <!--  Mobile View: Card Style -->
        <div class="lg:hidden space-y-4">
            @for (order of orders; track order.orderNumber) {<p-card class="shadow-sm" (click)="openTrackingModal(order)" >
                <ng-template pTemplate="header">
                    <div class="text-sm text-gray-600">
                        <p-tag severity="contrast">
  {{ order.orderNumber }}
</p-tag>
                    </div>
                </ng-template>

                <div class="text-sm">
                    <div class="mb-2">
                        <strong>Date:</strong> {{ order.orderDate | date: 'mediumDate' }}
                    </div>
                    <div class="mb-2">
                        <strong>Total:</strong> ₹{{ order.totalAmount.toFixed(2) }}
                    </div>
                    <div class="mb-2">
                        <strong>Payment:</strong> {{ order.paymentMode || 'N/A' }}
                    </div>
                    <div class="mb-2">
                        <strong>Status:</strong> {{ order.status }}
                    </div>
                    <div class="mb-2">
                        <strong>Items:</strong>
                        <ul class="pl-4 list-disc">
                            @for (item of order.items; track item.variantId) {
                            <li>
                                {{ item.productName }} ({{ item.quantity }}) - {{ item.size }}
                            </li>
                            }

                        </ul>
                    </div>
                </div>

                <ng-template pTemplate="footer">
                    <p-avatarGroup>
                        @for (item of order.items; track item.variantId) {
                        <p-overlay-badge [value]=item.quantity severity="contrast" class="inline-flex">
                            <p-avatar [image]="item.imageUrl" shape="square" size="xlarge" (click)="goToProductDetails(item.variantId)"></p-avatar>
                        </p-overlay-badge>
                        }

                    </p-avatarGroup>
                    <p-button label="View more info" class=" mt-5" severity="contrast" outlined></p-button>
                </ng-template>

            </p-card>}
        </div>
    </ng-container>}

    <!--  No Orders -->
    @if(!loading && orders.length === 0){<div class="text-center text-gray-500 mt-4">
        You have no order history yet.
    </div>}

    


</div>

<p-dialog
  header="Order Tracking"
  [(visible)]="displayTrackingModal"
  [modal]="true"
  [style]="{ width: '450px' }"
  [closable]="true"
  [dismissableMask]="true"
>
  <p-stepper [(value)]="activeStep" (onChange)="onStepSelect($event)">
    <p-step-item
      *ngFor="let step of steps"
      [value]="step.stepId"
      (click)="isStepClickable(step.stepId) && onStepSelect(step.stepId)"
      [class.p-disabled]="!isStepClickable(step.stepId)"
      style="cursor: pointer;"
    >
      <p-step>
        <span
          class="rounded-lg border-2 w-12 h-12 inline-flex items-center justify-center text-warning  bg-opacity-20"
          [ngClass]="{ 'opacity-50 cursor-not-allowed': !isStepClickable(step.stepId) }"
        >
          <i
            class="pi"
            [class.pi-shopping-bag]="step.stepId === 1"
            [class.pi-credit-card]="step.stepId === 2"
            [class.pi-cog]="step.stepId === 3"
            [class.pi-truck]="step.stepId === 4"
            [class.pi-check-circle]="step.stepId === 5"
          ></i>
        </span>
      </p-step>
      <p-step-panel>
        <ng-template #content let-activateCallback="activateCallback">
          <div class="flex flex-col h-48 justify-center items-center text-center px-4">
            <div class="text-lg font-semibold mb-2"><p-tag value="{{ step.label }}" severity="primary" class="text-lg font-semibold mb-2"></p-tag></div>
            <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
              <!-- Description based on step status -->
              @if(step.status === 'completed'){<ng-container >Step completed</ng-container>}
              @if(step.status === 'current'){<ng-container >
                <!-- Custom description per step -->
                <ng-container [ngSwitch]="step.stepId">
                  <p @if(step.stepId === 1)>Your order has been placed.</p>
                  <p @if(step.stepId === 2)>Payment has been received.</p>
                  <p @if(step.stepId === 3)>We are preparing your order.</p>
                  <p @if(step.stepId === 4)>Your order is on the way.</p>
                  <p @if(step.stepId === 5)>Your order has been delivered.</p>
                </ng-container>
              </ng-container>}
              @if(step.status === 'pending'){<ng-container >Pending step</ng-container>}
            </div>

            <!-- Details for each step -->
            @if(step.stepId === 1 && step.details){<div >
              <p><strong>Order Number:</strong> {{ step.details.orderNumber }}</p>
              <p><strong>Order Date:</strong> {{ step.details.orderDate | date:'medium' }}</p>
              <p><strong>Items:</strong></p>
              <ul class="text-left">
                @for (item of step.details.items; track item) {
  <li>
    {{ item.productName }} ({{ item.color }}, {{ item.size }}) x
    {{ item.quantity }} - ₹{{ item.total }}
  </li>
}

              </ul>
            </div>}

            @if(step.stepId === 2 && step.details){<div  >
              <p><strong>Payment Mode:</strong> {{ step.details.paymentMode }}</p>
              <p><strong>Total Amount:</strong> ₹{{ step.details.totalAmount }}</p>
              <p><strong>Order Number:</strong> {{ step.details.orderNumber }}</p>
            </div>}

            <!-- Add more details for other steps if desired -->

          </div>

          @if(step.stepId > 1 && step.stepId < 5){<div
            class="py-6 flex justify-between"
            
          >
            <p-button
               icon="pi pi-arrow-left"  raised outlined
              severity="contrast"
              (onClick)="activateCallback(step.stepId - 1)"
            ></p-button>
            <p-button
               icon="pi pi-arrow-right" raised outlined
              class="p-button-warning"
              (onClick)="activateCallback(step.stepId + 1)"
            ></p-button>
          </div>}

          @if(step.stepId === 1){<div class="py-6 flex justify-end" >
            <p-button
              icon="pi pi-arrow-right" raised outlined
              class="p-button-warning"
              (onClick)="activateCallback(2)"
            ></p-button>
          </div>}

          @if(step.stepId === 5){<div class="py-6 flex justify-start" >
            <p-button
              icon="pi pi-arrow-left"  raised outlined
              severity="contrast"
              (onClick)="activateCallback(4)"
            ></p-button>
          </div>}
        </ng-template>
      </p-step-panel>
    </p-step-item>
  </p-stepper>
</p-dialog>
